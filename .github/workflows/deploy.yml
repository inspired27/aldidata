name: Deploy to OCI VM

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Deploy with automatic rollback
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="/opt/aldiapp/app"
          SERVICE="aldiapp"
          HEALTH_URL="http://127.0.0.1:5000/"
          WAIT_SECONDS=30

          cd "$APP_DIR"

          echo "== Capture current commit for rollback =="
          PREV_COMMIT="$(git rev-parse HEAD)"
          echo "PREV_COMMIT=$PREV_COMMIT"

          echo "== Update code to origin/main =="
          git fetch origin
          git reset --hard origin/main
          NEW_COMMIT="$(git rev-parse HEAD)"
          echo "NEW_COMMIT=$NEW_COMMIT"

          echo "== Ensure venv exists =="
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi

          echo "== Install dependencies =="
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          echo "== Restart service =="
          sudo systemctl restart "$SERVICE"

          echo "== Health check (retry up to ${WAIT_SECONDS}s) =="
          ok=0
          for i in $(seq 1 "$WAIT_SECONDS"); do
            if curl -fsS --connect-timeout 2 --max-time 2 "$HEALTH_URL" > /dev/null; then
              echo "‚úÖ App is up on new commit."
              ok=1
              break
            fi
            echo "Waiting for app... ($i/${WAIT_SECONDS}) $(date -u +%H:%M:%S)"
            sleep 1
          done

          if [ "$ok" -eq 1 ]; then
            exit 0
          fi

          echo "‚ùå Deploy failed: app did not come back up. Rolling back..."
          echo "== Rollback to previous commit: $PREV_COMMIT =="
          git reset --hard "$PREV_COMMIT"

          echo "== Re-install dependencies for rollback commit =="
          source .venv/bin/activate
          pip install -r requirements.txt

          echo "== Restart service after rollback =="
          sudo systemctl restart "$SERVICE"

          echo "== Health check after rollback (retry up to ${WAIT_SECONDS}s) =="
          for i in $(seq 1 "$WAIT_SECONDS"); do
            if curl -fsS --connect-timeout 2 --max-time 2 "$HEALTH_URL" > /dev/null; then
              echo "‚úÖ Rollback succeeded: app is back up."
              echo "‚ö†Ô∏è Marking workflow as failed so you notice the rollback."
              exit 1
            fi
            echo "Waiting for app after rollback... ($i/${WAIT_SECONDS}) $(date -u +%H:%M:%S)"
            sleep 1
          done

          echo "üö® Rollback failed: app is still down."
          sudo systemctl status "$SERVICE" --no-pager || true
          journalctl -u "$SERVICE" -n 120 --no-pager || true
          exit 1
